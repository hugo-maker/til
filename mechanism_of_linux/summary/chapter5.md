# Chapter5

メモリ管理システム
- メモリ管理システムとは: Linuxにおいて、システムに搭載されている全メモリを管理しているカーネルの機能。
- メモリ使用量が増え、空きメモリが減少すると、カーネル内のメモリ領域を解放。
- OOMとは: カーネル内の解放可能領域がなくなるとOOM(Out Of Memory)状態となり、メモリが足りず身動きが取れなくなる。
- OOM killerとは: OOM状態になると、適当なプロセスを選んで強制終了することによってメモリ領域を解放する。

仮想記憶
- 仮想記憶とは: システムに搭載されているメモリに対して、プロセスから直接アクセスさせず、仮想アドレスを用いて間接的にアクセスさせる機能。
- 仮想アドレス: プロセス側から見えているメモリのアドレス⇔物理アドレス: システム搭載のメモリの実際のアドレス
- 単純なメモリ割当てが抱える問題点(メモリフラグメンテーションの発生、データ破壊、マルチプロセスの扱いの難しさ)を解決する。

- メモリフラグメンテーション→ページテーブルの設定により解消。
- データ破壊→仮想アドレス空間はプロセスごとに作られ、ページテーブルもプロセスごとに作られるため、そもそも他のプロセスのメモリへアクセス不可。カーネルのメモリは、全プロセスの仮想アドレス空間から見えてはいるものの、カーネルのメモリにアクセスできるのはカーネルのみであるため、問題なし。
- マルチプロセス→仮想アドレス空間は、プロセスごとに独立なため、問題なし。

ページテーブル
- ページテーブルとは: 仮想アドレスと物理アドレスを対応づけるために用いるデータ構造。
- ページフォールトとは: 物理アドレスに紐付いていない仮想アドレスにアクセスしようとすると発生する割り込み。
- ページフォールトハンドラとは: 実行中の命令がページフォールトによって中断された後に動く、カーネル内の処理。プロセスによるメモリアクセスが不正なものであることを検出し、SIGSEGVというシグナルでプロセスに通知する。通常、通知を受けたプロセスは強制終了させられる。

上位レイヤからの呼び出し
- C言語の標準ライブラリのmalloc()関数は、Linuxにおいては、内部的にmmap()関数を呼び出している。
- Python等のスクリプト言語においては、各オブジェクトの作成につき、最終的には内部でC言語のmalloc(),mmap()を呼び出している。(処理系がC言語プログラム)

ファイルマップ
- ファイルマップとは: ファイル領域を仮想アドレス空間にマップする機能。

デマンドページング
- デマンドページングとは: プロセスの仮想アドレス空間内の各ページに対応する物理メモリを、そのページに最初にアクセスした際に初めて割り当てる方法。
- 仮想メモリを確保した、とは: プロセスがmmap()関数などによってメモリを確保すること。
- 物理メモリを確保した、とは: 確保した仮想メモリにアクセスして(デマンドページングにより)物理メモリに紐付けられること。
- 仮想メモリの枯渇とは: プロセスが仮想アドレス空間の範囲一杯まで仮想メモリを使い切った状態でメモリの獲得を試みた際に発生。
- 物理メモリの枯渇とは: システム搭載の物理メモリがなくなること。

コピーオンライト
- コピーオンライトとは: 物理メモリを、fork()システムコール発行時ではなくその後の書き込み時にコピーするしくみ。
- fork()システムコール発行時には、親プロセスのページテーブルのみを子プロセスにコピーする(メモリはコピーしない)。
- fork()システムコール発行時、ページテーブルエントリ内の書き込み権限は無効化される。

スワップ
- スワップとは: 仮想記憶の仕組みを応用した、OOMに対する救済措置機能。ストレージデバイスの一部を一時的にメモリの代用とするしくみ。
- システムの物理メモリが枯渇した状態で物理メモリを獲得した際、既存の使用中の物理メモリのうち一部をストレージデバイスに退避する(=スワップアウト)ことで空きメモリを生み出す。
- メモリの退避場所をスワップ領域と呼ぶ。
- スワップアウトしたページに再アクセスすると、ページフォールトが発生した後、スワップ領域に退避していたデータが物理メモリに戻される(=スワップイン)。
- スワッピングとは: スワップイン/スワップアウトのこと。Linuxにおいては、スワップの単位がページごとのため、ページングとも(この場合、スワップイン=ページイン、スワップアウト=ページアウトとなる)。
- ストレージデバイスへのアクセス速度は、メモリへのアクセス速度に比べ桁違いに遅い→スラッシング(スワッピングが頻繁に繰り返されること)状態になると、システムが応答しなくなるなど、重大な問題につながる。
- メジャーフォールトとは: スワッピングのようにストレージデバイスへのアクセスが発生するページフォールト。マイナーフォールトよりも性能への影響度が大きい。
- マイナーフォールトとは: ストレージデバイスへのアクセスが発生しないページフォールト。

階層型ページテーブル
- x86\_64アーキテクチャのページテーブルは、階層構造をとることで、ページテーブルに必要なメモリ量を節約している。

ヒュージページ
- ヒュージページとは: 通常より大きなサイズのページのこと。ヒュージページの利用により、プロセスのページテーブルに必要なメモリ量を節約できる。
- 仮想メモリを大量に使用するプロセスにおいて特に有用。
- トランスペアレントヒュージページとは: Linuxの機能の一つ。仮想アドレス空間内の連続する複数の4kバイトページが所定の条件を満たしていれば、自動的にそれらをまとめてヒュージページを作成する。
